#!/usr/bin/env bash

top_dir="$(pwd)"
build_dir="$top_dir/.build"
include_dir="$build_dir/include"
lib_dir="$build_dir/lib"
contrib_dir="contrib"

cvc4_dir="src/SMT/cvc4"
pandoc_tangle_dir="$contrib_dir/pandoc-tangle"
git submodule update --init -- "$cvc4_dir" "$pandoc_tangle_dir"

(   cd "$cvc4_dir"
    ./autogen.sh
    ./contrib/get-antlr-3.4
    ./configure --prefix="$build_dir" \
                --with-antlr-dir="$(pwd)/antlr-3.4" ANTLR="$(pwd)/antlr-3.4/bin/antlr3"
    make -s -j4
    make -s install
)

automake --add-missing
aclocal
autoconf
autoheader
automake

./configure "$@"

make -s -j4

git checkout -- src/Mixfix/surface.cc

make -s -j4

( cd "$contrib_dir"
  make all || exit 1
)
