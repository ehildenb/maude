#!/usr/bin/env bash

# Settings/Utilities
# ------------------

set -e
set -u

top_dir="$(pwd)"
build_dir="$top_dir/.build"
include_dir="$build_dir/include"
lib_dir="$build_dir/lib"
contrib_dir="contrib"

pandoc_tangle_dir="$contrib_dir/pandoc-tangle"

export PATH="/usr/lib/ccache/bin:$PATH"
export PATH="/usr/lib/ccache:$PATH"

# Functionality
# -------------

build_clean() {
    rm -rf "$build_dir"
    make -s clean || true
    git clean -dfx
    [[ ! -f "ext/cvc4/Makefile" ]]   || ( cd "ext/cvc4"   ; make -s distclean )
    [[ ! -f "ext/yices2/Makefile" ]] || ( cd "ext/yices2" ; make -s clean     )
    ( cd "$contrib_dir"
      make clean
    )
}

build_deps() {
    git submodule update --init
}

build_cvc4() {
    mkdir -p $build_dir
    (  cd ext/cvc4/
       ./autogen.sh
       ./contrib/get-antlr-3.4
       ./configure --prefix="$build_dir" \
                   --with-antlr-dir=./antlr-3.4 \
                   ANTLR=./antlr-3.4/bin/antlr3
       make -s -j4
       make -s install
    )
}

build_yices2() {
    mkdir -p $build_dir
    (   cd ext/yices2/
        autoconf
        ./configure --prefix="$build_dir"
        make -s -j4
        make -s install
    )
}

build_maude() {
    aclocal
    autoconf
    autoheader
    automake --add-missing
    automake

    ./configure CXXFLAGS="-I$include_dir -L$lib_dir" "$@"
    make -s -j4 \
        || ( git checkout -- src/Mixfix/surface.cc
             make -s -j4
           )
}

build_maude_cvc4() {
    build_cvc4
    build_maude --with-cvc4 CVC4_LIB="-L$lib_dir -Wl,-R$lib_dir -lcvc4"
}

build_maude_yices2() {
    build_yices2
    build_maude --with-yices2 YICES2_LIB="-L$lib_dir -Wl,-R$lib_dir -lyices"
}

build_tangle() {
    (   cd "$contrib_dir"
        make all
    )
}

build_test() {
    local test_file_name test_name test_dir
    test_file_name="$1" && shift

    test_name="$(basename "$test_file_name")"
    test_dir="$(dirname "$test_file_name")"

    build_tangle

    {   cd "$test_dir"
        if ! make -s check TESTS=$test_name ; then
            git --no-pager diff --no-index $test_name.{expected,out}
            return 1
        fi
    }
}

build_test_all() {
    build_clean
    build_deps
    build_maude
    build_tangle
    make -s check "$@"
    git checkout -- src/Mixfix/tokenizer.cc
    build_maude_cvc4
    build_test tests/Misc/smtTest
    build_maude_yices2
    build_test tests/Misc/smtTest
}

# Main
# ----

build_command="$1" ; shift
case "$build_command" in
    clean)          build_clean         "$@" ;;
    deps)           build_deps          "$@" ;;
    maude)          build_maude         "$@" ;;
    maude-cvc4)     build_maude_cvc4    "$@" ;;
    maude-yices2)   build_maude_yices2  "$@" ;;
    tangle)         build_tangle        "$@" ;;
    test)           build_test          "$@" ;;
    test-all)       build_test_all      "$@" ;;
    *)      echo "
    usage: $0 [clean|deps|tangle]
           $0 maude <options>
           $0 test  <test-name>

    $0 clean:            remove build directory '$build_dir', and call 'make clean'.
    $0 deps:             clone git submodules and build CVC4.
    $0 maude <options>:  build maude passing <options> to the ./configure step.
    $0 maude-cvc4 ...:   build maude using the cvc4 git submodule
    $0 maude-yices2 ...: build maude using the yices2 git submodule
    $0 tangle:           generate '*.maude' files from '*.md' files in '$contrib_dir'.

    developers: $0 test <test-name>
                $0 test-all

    $0 test <test-path>: run test at <test-path> (eg. tests/tools/fvp/numbers).
    $0 test-all:         Clean build and test for CI servers.
" ;;
esac
